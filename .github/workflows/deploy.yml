name: Deploy to Server

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy with script
        run: |
          echo "üöÄ Deploying release: ${{ github.event.release.tag_name || 'manual' }}"
          
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
          scp -P ${{ secrets.SERVER_SSH_PORT }} \
            index.html \
            nginx.conf \
           ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}:/tmp/
          
          # –í—ã–ø–æ–ª–Ω—è–µ–º deploy –∫–æ–º–∞–Ω–¥—ã (–≤–º–µ—Å—Ç–æ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞)
          ssh -p ${{ secrets.SERVER_SSH_PORT }} root@${{ secrets.SERVER_HOST }} << 'EOF'
          
            # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
            sudo mkdir -p /var/www/demo
            
            # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã
            sudo cp /tmp/index.html /var/www/demo/
            
            # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º nginx
            sudo cp /tmp/nginx.conf /etc/nginx/sites-available/demo-site
            sudo ln -sf /etc/nginx/sites-available/demo-site /etc/nginx/sites-enabled/
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
            sudo nginx -t
            
            if [ $? -eq 0 ]; then
              sudo systemctl reload nginx
              echo "‚úÖ Nginx reloaded successfully"
            else
              echo "‚ùå Nginx config test failed"
              exit 1
            fi
            
            # –û—á–∏—Å—Ç–∫–∞
            rm /tmp/index.html /tmp/nginx.conf
          EOF
      
      - name: Test deployed site
        run: |
          echo "üåê Testing site at http://app.emec.course.prafdin.ru"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–∑–≤–Ω–µ)
          curl -f http://app.emec.course.prafdin.ru || \
            echo "‚ö†Ô∏è Site not accessible externally, but local check passed"
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ä–∞–∫–µ—Ç—ã —á–µ—Ä–µ–∑ SSH
          ssh -p ${{ secrets.SERVER_SSH_PORT }} ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} \
            "grep -q 'üöÄ' /var/www/demo/index.html && echo '‚úÖ Rocket found!' || echo '‚ùå Rocket missing!'"
